<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="SVNDirectoryStatistics">

    <insert id="insertStatistic" parameterClass="com.neosavvy.svn.analytics.dto.file.DirectoryNode">
        <selectKey keyProperty="id" type="pre" resultClass="int">
			SELECT SVN_DIRECTORY_STATISTIC_SEQ.NEXTVAL AS VALUE FROM DUAL
		</selectKey>
        INSERT INTO 
            SVN_DIRECTORY_STATISTIC
        (
            ID
			,REVISION
			,REVISION_DATE
			,LAST_CHANGED_REVISION
			,AUTHOR
			,RELATIVE_PATH
			,PARENT_DIRECTORY
			,REPOSITORY_ID
        )
        VALUES
        (
            #id#
            ,#revision#
            ,#revisionDate#
            ,#lastChangedRevision#
            ,#author#
            ,#relativePath#
            ,#parentDirectory#
            ,#repositoryId#
        )
    </insert> 
    
    <resultMap 
    	class="com.neosavvy.svn.analytics.dto.file.DirectoryNode" 
	    id="DirectoryNodeResultMap">
		<result property="relativePath" column="RELATIVE_PATH"/>
		<result property="lastChangedRevision" column="LAST_CHANGED_REVISION"/>
    </resultMap>  
  
  	<select id="getChildren" 
  		parameterClass="com.neosavvy.svn.analytics.dto.file.DirectoryNode"
  		resultMap="DirectoryNodeResultMap">
	  	SELECT 
		    RELATIVE_PATH 
		    ,MAX( LAST_CHANGED_REVISION ) AS LAST_CHANGED_REVISION
		FROM 
		    SVN_DIRECTORY_STATISTIC 
		WHERE 
		    NVL(PARENT_DIRECTORY,'/') = #parentDirectory#
		   	AND REPOSITORY_ID = #repositoryId#
		    AND RELATIVE_PATH IS NOT NULL
		GROUP BY 
		    RELATIVE_PATH
		ORDER BY 
		    RELATIVE_PATH
  	</select>

</sqlMap>