<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CodeOwnership">

    <typeAlias alias="CodeOwnershipDTO" type="com.neosavvy.svn.analytics.dto.CodeOwnershipDTO" />
    
    <resultMap class="CodeOwnershipDTO" id="CodeOwnershipDTOResultMap">
        <result column="AUTHOR" property="author"/>
		<result column="NUM_LINES_IN_REVISION" property="numberOfLinesInRevision"/>
		<result column="TOTAL_LINES" property="totalLines"/>
		<result column="CONTRIBUTION_RATE" property="contributionRatio"/>
    </resultMap>
    
    <select 
    	id="getOwnership" 
    	resultMap="CodeOwnershipDTOResultMap"
    	parameterClass="com.neosavvy.svn.analytics.dto.file.FileSystemNode">
        SELECT 
		    AUTHOR
		    ,NUM_LINES_IN_REVISION
		    ,TOTAL_LINES
		    ,ROUND(NUM_LINES_IN_REVISION / TOTAL_LINES, 8) * 100 AS CONTRIBUTION_RATE
		FROM 
		(SELECT 
		    AUTHOR
		    ,SUM(NUMBER_OF_LINES) AS NUM_LINES_IN_REVISION
		FROM 
		    SVN_FILE_SYSTEM_STATISTIC 
		WHERE 
		    RELATIVE_PATH LIKE #relativePath#
		GROUP BY
		    AUTHOR) A,
		(SELECT 
		    SUM(NUMBER_OF_LINES) AS TOTAL_LINES
		FROM 
		    SVN_FILE_SYSTEM_STATISTIC 
		WHERE 
		    RELATIVE_PATH LIKE #relativePath#
		) B
    </select>

</sqlMap>