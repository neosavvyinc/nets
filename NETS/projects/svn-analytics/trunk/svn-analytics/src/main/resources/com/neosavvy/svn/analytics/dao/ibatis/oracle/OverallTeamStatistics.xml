<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="OverallTeamStats">

    <typeAlias alias="OverallStatistic" type="com.neosavvy.svn.analytics.dto.OverallTeamStatistic" />
    <typeAlias alias="RefineSearch" type="com.neosavvy.svn.analytics.dto.request.RefineSearchRequest" />
    
    <resultMap class="OverallStatistic" id="OverallStatisticResultMap">
        <result column="author" property="author"/>
        <result column="numberOfCommits" property="numberOfCommits"/>
        <result column="numberOfFilesTouched" property="numberOfFilesTouched"/>
        <result column="numberOfFilesAdded" property="numberOfFilesAdded"/>
        <result column="numberOfFilesModified" property="numberOfFilesModified"/>
        <result column="numberOfFilesDeleted" property="numberOfFilesDeleted"/>
        <result column="validComments" property="numberOfCommentedCommits"/>
        <result column="invalidComments" property="numberOfUnCommentedCommits"/>
        <result column="firstCommitDate" property="firstCommitDate"/>
        <result column="lastCommitDate" property="lastCommitDate"/>
        <result column="numberOfFilesAddedRate" property="numberOfFilesAddedRate"/>
        <result column="numberOfFilesDeletedRate" property="numberOfFilesDeletedRate"/>
        <result column="numberOfFilesModifiedRate" property="numberOfFilesModifiedRate"/>
    </resultMap>
    
    <parameterMap class="RefineSearch" 
    	id="RefineSearchRequestParameterMap">
    	<parameter property="startDate"/>
    	<parameter property="endDate"/>
    	<parameter property="userNames"/>
   	</parameterMap>
    
    <select id="getOverallStatistics" 
    	resultMap="OverallStatisticResultMap"
    	parameterMap="RefineSearchRequestParameterMap">
        SELECT 
            author
            ,count(*) as numberOfCommits
            ,sum(num_files_in_rev) as numberOfFilesTouched
            ,sum(num_files_added_in_rev) as numberOfFilesAdded
            ,sum(num_files_deleted_in_rev) as numberOfFilesDeleted
            ,sum(num_files_modified_in_rev) as numberOfFilesModified
            ,sum(valid_comment) as validComments
            ,sum(invalid_comment) as invalidComments
            ,min(rev_date) as firstCommitDate
            ,max(rev_date) as lastCommitDate 
            ,CASE sum(num_files_in_rev) 
            	WHEN NULL THEN 0
            	WHEN 0 THEN 0
            	ELSE 
            		COALESCE(0,sum(num_files_added_in_rev) / sum(num_files_in_rev) * 100) 
            END as numberOfFilesAddedRate
            ,CASE sum(num_files_in_rev) 
            	WHEN NULL THEN 0
            	WHEN 0 THEN 0
            	ELSE
            		COALESCE(0,sum(num_files_deleted_in_rev) / sum(num_files_in_rev) * 100) 
            END as numberOfFilesDeletedRate
            ,CASE sum(num_files_in_rev) 
            	WHEN NULL THEN 0
            	WHEN 0 THEN 0
            	ELSE
            		COALESCE(0,sum(num_files_modified_in_rev) / sum(num_files_in_rev) * 100) 
            END as numberOfFilesModifiedRate
        FROM 
            SVN_STATISTIC
        <isParameterPresent prepend="WHERE">
        	<isNotEmpty property="userNames">
        		<iterate property="userNames" prepend="AUTHOR IN" open="(" close=")" conjunction=","> 
        			#userNames[]#
        		</iterate>
        	</isNotEmpty>
        	<isNotEmpty property="repositories" prepend="AND">
        		<iterate property="repositories" prepend="SVN_REPOSITORY_URL IN" open="(" close=")" conjunction=","> 
        			#repositories[].url#
        		</iterate>
        	</isNotEmpty>     
            <isNotEmpty property="startDate" prepend="AND">
            	REV_DATE &gt;= #startDate#
            </isNotEmpty>
            <isNotEmpty property="endDate" prepend="AND">
            	REV_DATE &lt;= #endDate#
            </isNotEmpty>
        </isParameterPresent>    
        GROUP BY 
            author 
        ORDER BY
 	        numberOfCommits DESC
    </select>

</sqlMap>