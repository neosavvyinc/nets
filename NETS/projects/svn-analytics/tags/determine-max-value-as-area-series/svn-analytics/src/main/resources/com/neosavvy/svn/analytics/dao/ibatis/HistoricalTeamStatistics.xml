<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="HistoricalTeamStatistics">

    <typeAlias alias="HistoricalTeamStatistic" type="com.neosavvy.svn.analytics.dto.HistoricalTeamStatistic" />
    
    <resultMap class="HistoricalTeamStatistic" id="HistoricalTeamStatisticResultMap">
        <result column="revisionDate" property="revisionDate"/>
        <result column="numberfOfFiles" property="numberfOfFiles"/>
        <result column="numberOfFilesAdded" property="numberOfFilesAdded"/>
        <result column="numberOfFilesDeleted" property="numberOfFilesDeleted"/>
        <result column="numberOfFilesModified" property="numberOfFilesModified"/>
        <result column="validComments" property="numberOfCommentedCommits"/>
        <result column="invalidComments" property="numberOfUnCommentedCommits"/>
        <result column="maxValue" property="maxValue"/>
    </resultMap>
    
    <parameterMap class="com.neosavvy.svn.analytics.dto.request.RefineSearchRequest" id="refineRequest">
    	<parameter property="incrementType" javaType="java.lang.String"/>
    	<parameter property="userNames"/>
    	<parameter property="startDate"/>
    	<parameter property="endDate"/>
    </parameterMap>
    
    <sql id="maxValueCalculation">
	    (
		    SELECT MAX(MAX_VALUE) as MAX_VALUE_OF_MEASURES FROM 
		    (
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(NUM_FILES_IN_REV) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
				UNION
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(NUM_FILES_ADDED_IN_REV) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
				UNION
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(NUM_FILES_DELETED_IN_REV) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
				UNION
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(NUM_FILES_MODIFIED_IN_REV) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
				UNION
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(valid_comment) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
				UNION
				SELECT
				    <include refid="revisionDateInclude"/>
				    ,SUM(invalid_comment) AS MAX_VALUE
				FROM
				    SVN_STATISTIC
				GROUP BY 
				    <include refid="revisionDateInclude"/>
			)
		) 
    </sql>
    
    <sql id="revisionDateInclude">
    	<isParameterPresent>
       		<isEqual property="incrementType" compareValue="monthly">
        		to_char(REV_DATE,'YYYY-MM')
        	</isEqual>
        	<isEqual property="incrementType" compareValue="daily">
        		to_char(REV_DATE,'YYYY-MM-DD')
        	</isEqual>
       	</isParameterPresent>
       	<isNotParameterPresent>
       		to_char(REV_DATE,'YYYY-MM')
       	</isNotParameterPresent>
    </sql>
    
    <select id="getHistoricalStatistics" 
    	resultMap="HistoricalTeamStatisticResultMap"
    	parameterMap="refineRequest">
        SELECT 
        	<include refid="revisionDateInclude"/> as revisionDate
            ,SUM(NUM_FILES_IN_REV) as numberfOfFiles
            ,SUM(NUM_FILES_ADDED_IN_REV) as numberOfFilesAdded
            ,SUM(NUM_FILES_DELETED_IN_REV) as numberOfFilesDeleted  
            ,SUM(NUM_FILES_MODIFIED_IN_REV) as numberOfFilesModified
            ,sum(valid_comment) as validComments
            ,sum(invalid_comment) as invalidComments
            ,<include refid="maxValueCalculation"/> as maxValue
        FROM 
            SVN_STATISTIC
			<isParameterPresent prepend="WHERE">
				<isNotEmpty property="userNames">
					<iterate property="userNames" prepend="AUTHOR IN" open="("
						close=")" conjunction=",">
						#userNames[]#
			       		</iterate>
				</isNotEmpty>
				<isNotEmpty property="repositories" prepend="AND">
	        		<iterate property="repositories" prepend="SVN_REPOSITORY_URL IN" open="(" close=")" conjunction=","> 
	        			#repositories[].url#
	        		</iterate>
	        	</isNotEmpty>  
				<isNotEmpty property="startDate" prepend="AND">
					REV_DATE &gt;= #startDate#
	            </isNotEmpty>
	            <isNotEmpty property="endDate" prepend="AND">
	           		REV_DATE &lt;= #endDate#
	            </isNotEmpty>
			</isParameterPresent>
        GROUP BY 
        	<include refid="revisionDateInclude"/>
        ORDER BY 
        	<include refid="revisionDateInclude"/>
    </select>
    
    
</sqlMap>